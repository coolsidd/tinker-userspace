<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>tinker-userspace: Tinker Userspace</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">tinker-userspace
   </div>
   <div id="projectbrief">explore user space libraries you use and abuse but take for granted.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_README.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Tinker Userspace </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In tinker-userspace you explore user space libraries you use and abuse but take for granted. user space libraries perform a lot of the heavy lifting for you and bridge the gap between sophisticated kernel calls and clean user-friendly APIs. You try to implement some functionality and in the process learn something about it, Linux kernels, computers and life.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
User space no kernel space no user space</h1>
<p><em>You:</em> Just what the hell is this, I came here to write code? <em>Tinker:</em> User code runs in user space. Kernel code runs in kernel space.</p>
<p><em>You:</em> That didn't help. <em>Tinker:</em> I know. So let's clear up something. Linux is the kernel and Ubuntu is the operating system (OS). The kernel contains code that interacts directly with the hardware like when you plugin your keyboard kernel code detects the device. Most of the applications that come installed with your application run in the user space. Nautilus your file browser, Firefox your web browser, Vim your text editor and your cracked game all run in user space.</p>
<p><em>You:</em> Where did space come into running code? <em>Tinker:</em> Here space refers to memory. User space is the region of memory where user code executes. It also refers to the privilege level of the code where kernel space has more privilege.</p>
<p><em>You:</em> So code means process, so a process runs in one space or the other? <em>Tinker:</em> Not exactly. the same process can switch between kernel mode and user mode depending on the code it is running. For e.g. <code>printf</code> is <a href="https://oded.blog/2017/05/24/printf/">sophisticated wrapper</a> around the <code>write</code> kernel call. When you call <code>printf</code> in user space it calls <code>write</code> kernel call internally. <code>write</code> executes in kernel space, does whatever it needs to and then returns to user space.</p>
<p><em>You:</em> Higher priviledges kernel code thinks it's special? <em>Tinker:</em> Kernel code interacts with hardware and it wants to feel secure that it is doing something important, because it is. Priviledges are way to make sure other process can't meddle with its operations. Try this <code>ps -lp 1</code>, it's the systemd process which is the first process to startup. Now try <code>ps -o user= -p 1</code>, see systemd executes in root to perform <a href="https://www.linode.com/docs/quick-answers/linux-essentials/what-is-systemd/">its duties</a>.</p>
<p><em>You:</em> Awesome so I can use <code>sudo</code> to change kernel code? <em>Tinker:</em> Finally you get it, try <code>sudo rm -rf /</code>. <em>DONT</em>. Super User DO (<code>sudo</code>) means you can run commands with escalated privileges, to modify settings or install packages etc. To change kernel code you can <a href="http://derekmolloy.ie/writing-a-linux-kernel-module-part-1-introduction/">hot-load your own module</a> into the kernel or modify the source code of the kernel and <a href="https://www.linux.com/tutorials/how-compile-linux-kernel-0/">compile it yourself</a>.</p>
<p><em>You:</em> Mmmmm, I want more <em>Tinker:</em> <a href="https://unix.stackexchange.com/questions/87625/what-is-difference-between-user-space-and-kernel-space">link</a></p>
<p><em>You:</em> Not enough <em>Tinker:</em> <a href="https://www.redhat.com/en/blog/architecting-containers-part-1-why-understanding-user-space-vs-kernel-space-matters">link</a></p>
<h1><a class="anchor" id="autotoc_md2"></a>
Exploring &lt;tt&gt;malloc&lt;/tt&gt;</h1>
<p><em>Tinker:</em> Now that you are primed let's dig into <code>malloc</code>. You use it to allocate a block of memory. But do you know how it works, what goes on behind the scenes?</p>
<p><em>You:</em> Psshh, I know what <code>malloc</code> is it's a system call. I pass it the number of bytes and it gives me a pointer to the memory block. And let me tell you something else. I know <code>free</code> as well. I give it a block of memory and it gives it back to OS. <a href="https://linux.die.net/man/3/malloc">link</a>.</p>
<p><em>Tinker:</em> Ummm actually <code>malloc</code> is <a href="https://www.humblec.com/who-told-malloc-is-a-system-call/">not a system call</a> and <code>free</code> <a href="https://stackoverflow.com/questions/45538993/why-dont-memory-allocators-actively-return-freed-memory-to-the-os">doesn't always return memory</a> to the OS.</p>
<p><em>You:</em> Say what?!</p>
<p><em>Tinker:</em> So <code>malloc</code> just like <code>printf</code> is actually a wrapper on the <code>sbrk</code> and <code>mmap</code> system call (depending on the usage). <code>malloc</code> is just another userspace code implemented in the glibc library that you can use when you <code>#include &lt;stdlib.h&gt;</code>. System calls should be used sparingly, so malloc does a lot of in-house memory management so when you <code>free</code> mem ....</p>
<p><em>You:</em> Whoooaaa <code>malloc</code> manages memory. But.. doesn't that mean it will need data structures and algorithms and take a lot of time and consume a lot of memory.</p>
<p><em>Tinker:</em> ... Exactly and that's what you'll explore by trying to implement something like <code>malloc</code>. As I was saying <code>free</code> actually returns memory to the <code>malloc</code> code. <code>malloc</code> adds this to its list of unused memory and very rarely it actually returns memory to the OS.</p>
<h1><a class="anchor" id="autotoc_md3"></a>
Finally the code</h1>
<blockquote class="doxtable">
<p><code>tmalloc.c</code> </p>
</blockquote>
<p>This your wannabe <code>malloc</code> implementation. It has three public APIs namely,</p><ul>
<li><code>init_tmalloc</code> to choose the algorithms</li>
<li><code>tmalloc</code> shows same behaviour as <code>malloc</code></li>
<li><code>tfree</code> shows same behaviour as <code>free</code></li>
</ul>
<blockquote class="doxtable">
<p><code><a class="el" href="consume__memory_8c.html">consume_memory.c</a></code> </p>
</blockquote>
<p>This is a user program. It asks for memory uses it and frees it. A random number generator (RNG) is used to decide whether to allocate or free memory. The RNG also decides the amount of memory to allocate. Your <code>tmalloc</code> will be benchmarked on this program.</p>
<h1><a class="anchor" id="autotoc_md4"></a>
Instructions</h1>
<p>Ideally you should be using an OS with the latest kernel version. </p><div class="fragment"><div class="line">gcc request_memory.c</div>
<div class="line">ulimit -S -v 10240</div>
<div class="line">./a.out</div>
<div class="line">ulimit -S -v unlimited</div>
</div><!-- fragment --><div class="fragment"><div class="line">gcc malloc.c</div>
<div class="line">ulimit -S -v 10240</div>
<div class="line">./a.out</div>
<div class="line">ulimit -S -v unlimited</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md5"></a>
Measure performance</h1>
<p>The <code><a class="el" href="consume__memory_8c.html">consume_memory.c</a></code> script behaves like a user program. It asks for memory and frees it. A random number generator (RNG) is used to decide whether to allocate or free memory. The RNG also decides the amount of memory to allocate.</p>
<p>Just like <code>malloc</code>, <code>tmalloc</code> fails when it cannot successfully allocate the requested amount of memory. This can happen when there is no continous free block of the requested size or the program has reached memory limit. On failure <code>tmalloc</code> returns <code>NULL</code>. The number of operations performed before <code>tmalloc</code> fails is used as a measure of how well it is managing the memory.</p>
<p>You pit your implementation of malloc with the standard library implementation to see which performs better.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Using the best list implementation</h1>
<p><a href="https://github.com/torvalds/linux/blob/master/include/linux/llist.h">linux/llist.h</a></p>
<h1><a class="anchor" id="autotoc_md7"></a>
References</h1>
<ul>
<li><a href="https://stackoverflow.com/questions/5957570/what-is-the-difference-between-the-kernel-space-and-the-user-space">difference between kernel space and userspace</a></li>
<li><a href="http://geekswing.com/geek/quickie-tutorial-ulimit-soft-limits-hard-limits-soft-stack-hard-stack/">restricting heap memory</a></li>
<li><a href="https://ss64.com/bash/ulimit.html">ulimit man page</a></li>
<li><a href="https://unix.stackexchange.com/questions/438986/is-setting-ulimit-v-sufficient-to-avoid-memory-leak">limit virtual memory for program</a></li>
<li><a href="https://sploitfun.wordpress.com/2015/02/11/syscalls-used-by-malloc/">syscalls used by malloc</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md8"></a>
TODO</h1>
<ul>
<li><a href="https://medium.com/@nickteixeira/stack-vs-heap-whats-the-difference-and-why-should-i-care-5abc78da1a88">Explain Stack vs Heap to explain the role of malloc</a></li>
<li><a href="http://www.etalabs.net/overcommit.html">considering overcommit</a></li>
<li><a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html">Malloc source code</a></li>
<li><a href="http://gee.cs.oswego.edu/dl/html/malloc.html">Good malloc</a></li>
<li><a href="https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/">Understanding malloc</a></li>
<li><a href="https://www.usna.edu/Users/cs/aviv/classes/ic221/s16/lec/11/lec.html">Understanding sbrk</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.16 </li>
  </ul>
</div>
</body>
</html>
